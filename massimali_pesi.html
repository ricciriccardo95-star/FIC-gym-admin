<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Massimali Atleti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* Slate 900 */
            color: #E2E8F0; /* Slate 200 */
        }
        .background-gradient {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            filter: blur(100px); z-index: -1;
        }
        .gradient-1 {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.3), transparent 70%);
            animation: pulse 10s infinite alternate;
        }
        .gradient-2 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.2), transparent 70%);
            animation: pulse 12s infinite alternate-reverse;
        }
        @keyframes pulse {
            0% { transform: scale(0.9) rotate(0deg); }
            100% { transform: scale(1.2) rotate(20deg); }
        }
        /* Stile per scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .athlete-list-item.selected {
            background-color: #334155; /* Slate 700 */
            color: #f1f5f9; /* Slate 100 */
        }
    </style>
</head>
<body class="antialiased">

    <div class="background-gradient gradient-1"></div>
    <div class="background-gradient gradient-2"></div>

    <div class="p-4 md:p-8 max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl md:text-4xl font-black tracking-tight text-slate-100">Gestione Massimali</h1>
            <a href="index.html" class="inline-flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold rounded-lg shadow transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                Indietro
            </a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Colonna Sinistra: Lista Atleti -->
            <div class="lg:col-span-1 bg-slate-900/70 border border-slate-700/50 rounded-xl backdrop-blur-lg p-6 flex flex-col">
                <h2 class="text-2xl font-bold text-white mb-4">Lista Atleti</h2>
                <div class="mb-4">
                    <input type="text" id="athlete-search" placeholder="Cerca atleta..." class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="athlete-list" class="flex-grow space-y-2 overflow-y-auto max-h-[65vh] pr-2">
                    <!-- Atleti caricati da JS -->
                </div>
            </div>

            <!-- Colonna Destra: Tabella Massimali -->
            <div class="lg:col-span-2 bg-slate-900/70 border border-slate-700/50 rounded-xl backdrop-blur-lg p-6">
                <div id="max-lifts-container" class="hidden">
                    <h2 class="text-2xl font-bold text-white mb-4">Massimali per <span id="selected-athlete-name" class="text-sky-400"></span></h2>
                    <div class="overflow-y-auto max-h-[60vh]">
                        <table class="w-full text-left">
                            <thead class="sticky top-0 bg-slate-800">
                                <tr>
                                    <th class="p-3">Esercizio</th>
                                    <th class="p-3 w-40">Massimale (kg)</th>
                                </tr>
                            </thead>
                            <tbody id="max-lifts-table-body">
                                <!-- Righe caricate da JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button id="save-max-lifts-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Salva Massimali</button>
                    </div>
                </div>
                <div id="placeholder-container" class="flex items-center justify-center h-full">
                    <p class="text-slate-400 text-center">Seleziona un atleta dalla lista per visualizzare o inserire i massimali.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Notifica -->
    <div id="notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAQ_0F8KCks_4Wn2h2aTIepQY9VrIkWpUQ",
            authDomain: "database-atleti-fic.firebaseapp.com",
            projectId: "database-atleti-fic",
            storageBucket: "database-atleti-fic.appspot.com",
            messagingSenderId: "860422140545",
            appId: "1:860422140545:web:cd14c042a47f2650681380"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Cache dati per ottimizzare letture
        let athletes = [];
        let exercisesLibrary = [];
        let currentAthleteId = null;

        // Elementi DOM
        const athleteListContainer = document.getElementById('athlete-list');
        const athleteSearchInput = document.getElementById('athlete-search');
        const maxLiftsContainer = document.getElementById('max-lifts-container');
        const placeholderContainer = document.getElementById('placeholder-container');
        const selectedAthleteNameEl = document.getElementById('selected-athlete-name');
        const maxLiftsTableBody = document.getElementById('max-lifts-table-body');
        const notificationEl = document.getElementById('notification');

        function showNotification(message, type = 'success') {
            notificationEl.textContent = message;
            notificationEl.className = 'fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-all'; // Reset
            if (type === 'success') notificationEl.classList.add('bg-green-500');
            else if (type === 'error') notificationEl.classList.add('bg-red-500');
            notificationEl.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                notificationEl.classList.add('opacity-0', 'translate-y-2');
            }, 3000);
        }

        async function loadAthletes() {
            try {
                const querySnapshot = await getDocs(collection(db, "atleti"));
                athletes = [];
                querySnapshot.forEach(doc => {
                    athletes.push({ id: doc.id, ...doc.data() });
                });
                // Ordina per nome e cognome
                athletes.sort((a, b) => {
                    const nameA = `${a.nome || ''} ${a.cognome || ''}`.trim();
                    const nameB = `${b.nome || ''} ${b.cognome || ''}`.trim();
                    return nameA.localeCompare(nameB);
                });
                renderAthletes(athletes);
            } catch (error) {
                console.error("Errore nel caricamento degli atleti:", error);
                athleteListContainer.innerHTML = '<p class="text-red-400">Errore caricamento atleti.</p>';
            }
        }

        function renderAthletes(athletesToRender) {
            athleteListContainer.innerHTML = '';
            if (athletesToRender.length === 0) {
                athleteListContainer.innerHTML = '<p class="text-slate-400">Nessun atleta trovato.</p>';
                return;
            }
            athletesToRender.forEach(athlete => {
                const div = document.createElement('div');
                div.className = 'athlete-list-item p-3 bg-slate-800 rounded-lg cursor-pointer hover:bg-slate-700 transition-colors';
                div.textContent = `${athlete.nome || ''} ${athlete.cognome || ''}`.trim();
                div.dataset.athleteId = athlete.id;
                div.addEventListener('click', () => handleAthleteSelection(athlete.id));
                athleteListContainer.appendChild(div);
            });
        }
        
        async function loadExercises() {
             try {
                const querySnapshot = await getDocs(collection(db, "esercizi_pesistica"));
                exercisesLibrary = [];
                querySnapshot.forEach((doc) => {
                    exercisesLibrary.push({ id: doc.id, ...doc.data() });
                });
                exercisesLibrary.sort((a,b) => a.nome.localeCompare(b.nome));
            } catch (error) {
                console.error("Errore nel caricare gli esercizi:", error);
            }
        }

        async function handleAthleteSelection(athleteId) {
            currentAthleteId = athleteId;
            const athlete = athletes.find(a => a.id === athleteId);
            if (!athlete) return;
            
            document.querySelectorAll('.athlete-list-item').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-athlete-id="${athleteId}"]`).classList.add('selected');

            selectedAthleteNameEl.textContent = `${athlete.nome || ''} ${athlete.cognome || ''}`.trim();
            maxLiftsContainer.classList.remove('hidden');
            placeholderContainer.classList.add('hidden');
            
            renderMaxLiftsTable();
        }

        async function renderMaxLiftsTable() {
            maxLiftsTableBody.innerHTML = '<tr><td colspan="2" class="p-4 text-center text-slate-400">Caricamento massimali...</td></tr>';
            
            // Unica lettura per i massimali dell'atleta selezionato
            const q = query(collection(db, "massimali_atleti"), where("atletaId", "==", currentAthleteId));
            const querySnapshot = await getDocs(q);
            const existingLifts = new Map();
            querySnapshot.forEach(doc => {
                const data = doc.data();
                existingLifts.set(data.esercizioId, { massimale: data.massimale });
            });

            maxLiftsTableBody.innerHTML = '';
            exercisesLibrary.forEach(exercise => {
                const liftData = existingLifts.get(exercise.id);
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-700/50';
                tr.dataset.exerciseId = exercise.id;
                tr.innerHTML = `
                    <td class="p-3 font-medium">${exercise.nome}</td>
                    <td class="p-3">
                        <input type="number" placeholder="-" class="max-lift-input w-full bg-slate-800 border border-slate-600 rounded px-2 py-1 text-center" value="${liftData ? liftData.massimale : ''}">
                    </td>
                `;
                maxLiftsTableBody.appendChild(tr);
            });
        }
        
        async function saveMaxLifts() {
            if (!currentAthleteId) {
                showNotification("Nessun atleta selezionato.", 'error');
                return;
            }

            const currentAthlete = athletes.find(a => a.id === currentAthleteId);
            if (!currentAthlete) {
                showNotification("Errore: atleta non trovato.", 'error');
                return;
            }
            
            const batch = writeBatch(db);
            const rows = maxLiftsTableBody.querySelectorAll('tr');

            rows.forEach(row => {
                const exerciseId = row.dataset.exerciseId;
                const massimaleInput = row.querySelector('.max-lift-input');
                const massimale = massimaleInput.value;
                const exercise = exercisesLibrary.find(ex => ex.id === exerciseId);

                if (massimale && massimale > 0 && exercise) {
                    const docId = `${currentAthleteId}_${exerciseId}`;
                    const liftRef = doc(db, "massimali_atleti", docId);
                    batch.set(liftRef, {
                        atletaId: currentAthleteId,
                        nomeAtleta: currentAthlete.nome || '',
                        cognomeAtleta: currentAthlete.cognome || '',
                        esercizioId: exerciseId,
                        nomeEsercizio: exercise.nome,
                        massimale: parseFloat(massimale)
                    });
                }
            });

            try {
                await batch.commit();
                showNotification("Massimali salvati con successo!");
            } catch (error) {
                console.error("Errore nel salvataggio dei massimali: ", error);
                showNotification("Errore durante il salvataggio.", 'error');
            }
        }


        async function initializePage() {
            // Carica le liste principali una sola volta
            await loadExercises();
            await loadAthletes();
        }

        initializePage();
        
        // Event Listeners
        document.getElementById('save-max-lifts-btn').addEventListener('click', saveMaxLifts);

        athleteSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            const filteredAthletes = athletes.filter(athlete => {
                const fullName = `${athlete.nome || ''} ${athlete.cognome || ''}`.toLowerCase();
                return fullName.includes(searchTerm);
            });
            renderAthletes(filteredAthletes);
        });

    </script>
</body>
</html>

