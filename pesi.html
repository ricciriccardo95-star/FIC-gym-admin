<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Schede Pesistica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Libreria per il ritaglio immagini (Cropper.js) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* Slate 900 */
            color: #E2E8F0; /* Slate 200 */
        }
        .background-gradient {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            filter: blur(100px); z-index: -1;
        }
        .gradient-1 {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.3), transparent 70%);
            animation: pulse 10s infinite alternate;
        }
        .gradient-2 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.2), transparent 70%);
            animation: pulse 12s infinite alternate-reverse;
        }
        @keyframes pulse {
            0% { transform: scale(0.9) rotate(0deg); }
            100% { transform: scale(1.2) rotate(20deg); }
        }
        /* Stile per scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Stili per il cropper */
        .cropper-container { max-height: 400px; }
        .cropper-view-box, .cropper-face { border-radius: 0.5rem; }
    </style>
</head>
<body class="antialiased">

    <div class="background-gradient gradient-1"></div>
    <div class="background-gradient gradient-2"></div>

    <div class="p-4 md:p-8 max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl md:text-4xl font-black tracking-tight text-slate-100">Gestione Pesistica</h1>
            <a href="index.html" class="inline-flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold rounded-lg shadow transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                Indietro
            </a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Colonna Sinistra: Libreria Esercizi -->
            <div class="lg:col-span-1 bg-slate-900/70 border border-slate-700/50 rounded-xl backdrop-blur-lg p-6 flex flex-col">
                <h2 class="text-2xl font-bold text-white mb-4">Libreria Esercizi</h2>
                <div class="mb-4">
                    <input type="text" id="exerciseSearch" placeholder="Cerca esercizio..." class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="exercise-list" class="flex-grow space-y-2 overflow-y-auto max-h-[60vh] pr-2">
                    <!-- Esercizi caricati da JS -->
                </div>
                <button id="add-exercise-btn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    + Aggiungi Nuovo Esercizio
                </button>
            </div>

            <!-- Colonna Destra: Creazione Scheda -->
            <div class="lg:col-span-2 bg-slate-900/70 border border-slate-700/50 rounded-xl backdrop-blur-lg p-6">
                <input type="hidden" id="editing-plan-id">
                <h2 class="text-2xl font-bold text-white mb-4">Crea Nuova Scheda</h2>
                <div class="mb-6">
                    <label for="scheda-name" class="block mb-2 font-medium text-slate-300">Nome Scheda</label>
                    <input type="text" id="scheda-name" placeholder="Es. Scheda A - Forza Massimale" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <h3 class="text-lg font-semibold text-slate-200 mb-3">Esercizi nella scheda</h3>
                <div id="plan-exercises" class="space-y-4 min-h-[200px] bg-slate-800/50 p-4 rounded-lg">
                    <p id="plan-placeholder" class="text-slate-400 text-center">Trascina o clicca un esercizio dalla libreria per aggiungerlo qui.</p>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button id="clear-plan-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Pulisci</button>
                    <button id="save-plan-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Salva Scheda</button>
                </div>
            </div>
        </div>

        <!-- Sezione Riepilogo Schede Salvate -->
        <div class="mt-12 bg-slate-900/70 border border-slate-700/50 rounded-xl backdrop-blur-lg p-6">
            <h2 class="text-2xl font-bold text-white mb-4">Schede Salvate</h2>
            <div id="saved-plans-list" class="space-y-3"></div>
        </div>
    </div>

    <!-- Modal per Aggiungere/Modificare Esercizio -->
    <div id="exercise-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-8 w-full max-w-md">
            <h3 id="modal-title" class="text-2xl font-bold text-white mb-6">Nuovo Esercizio</h3>
            <input type="hidden" id="exercise-id-input">
            <div class="space-y-4">
                <div>
                    <label for="exercise-name-input" class="block mb-2 font-medium text-slate-300">Nome Esercizio</label>
                    <input type="text" id="exercise-name-input" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="exercise-image-input" class="block mb-2 font-medium text-slate-300">Immagine Esercizio</label>
                    <input type="file" id="exercise-image-input" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-500 cursor-pointer" accept="image/*">
                </div>
                <div id="image-cropper-container" class="hidden mt-4">
                    <img id="image-to-crop" class="max-w-full">
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button id="cancel-exercise-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg">Annulla</button>
                <button id="save-exercise-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-6 rounded-lg">Salva</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Conferma Eliminazione -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-8 w-full max-w-sm text-center">
            <h3 class="text-xl font-bold text-white mb-4">Sei sicuro?</h3>
            <p class="text-slate-300 mb-6">Vuoi davvero eliminare questa scheda? L'azione è irreversibile.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg">Annulla</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg">Elimina</button>
            </div>
        </div>
    </div>

    <!-- Notifica -->
    <div id="notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAQ_0F8KCks_4Wn2h2aTIepQY9VrIkWpUQ",
            authDomain: "database-atleti-fic.firebaseapp.com",
            projectId: "database-atleti-fic",
            // Ho corretto questo campo con il nome del bucket giusto
            storageBucket: "database-atleti-fic.firebasestorage.app",
            messagingSenderId: "860422140545",
            appId: "1:860422140545:web:cd14c042a47f2650681380"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let exercisesLibrary = [];
        let savedPlans = [];
        let cropper = null;
        let originalImageURL = null;

        // Elementi DOM
        const exerciseListContainer = document.getElementById('exercise-list');
        const planExercisesContainer = document.getElementById('plan-exercises');
        const planPlaceholder = document.getElementById('plan-placeholder');
        const exerciseModal = document.getElementById('exercise-modal');
        const notificationEl = document.getElementById('notification');
        const modalTitle = document.getElementById('modal-title');
        const exerciseIdInput = document.getElementById('exercise-id-input');
        const exerciseNameInput = document.getElementById('exercise-name-input');
        const exerciseImageInput = document.getElementById('exercise-image-input');
        const savedPlansListContainer = document.getElementById('saved-plans-list');
        const editingPlanIdInput = document.getElementById('editing-plan-id');
        const savePlanBtn = document.getElementById('save-plan-btn');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const imageCropperContainer = document.getElementById('image-cropper-container');
        const imageToCrop = document.getElementById('image-to-crop');
        
        function showNotification(message, type = 'success') {
            notificationEl.textContent = message;
            notificationEl.className = 'fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-all'; // Reset
            if (type === 'success') notificationEl.classList.add('bg-green-500');
            else if (type === 'error') notificationEl.classList.add('bg-red-500');
            else notificationEl.classList.add('bg-blue-500');
            notificationEl.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                notificationEl.classList.add('opacity-0', 'translate-y-2');
            }, 3000);
        }

        async function populateInitialExercises() {
             const initialExercises = [
                { nome: "BACK SQUAT", imageUrl: "https://placehold.co/100x100/334155/e2e8f0?text=SQUAT" },
                { nome: "PANCA PIANA", imageUrl: "https://placehold.co/100x100/334155/e2e8f0?text=PANCA" },
                { nome: "STACCHI", imageUrl: "https://placehold.co/100x100/334155/e2e8f0?text=STACCO" },
            ];
            const promises = initialExercises.map(ex => addDoc(collection(db, "esercizi_pesistica"), ex));
            await Promise.all(promises);
            console.log("Esercizi iniziali popolati in Firestore.");
        }

        async function loadAndRenderExercises() {
            exerciseListContainer.innerHTML = '<p class="text-slate-400">Caricamento...</p>';
            try {
                const querySnapshot = await getDocs(collection(db, "esercizi_pesistica"));
                
                if (querySnapshot.empty) {
                    await populateInitialExercises();
                    await loadAndRenderExercises(); // Ricariamo dopo aver popolato
                    return;
                }

                exercisesLibrary = [];
                querySnapshot.forEach((doc) => {
                    exercisesLibrary.push({ id: doc.id, ...doc.data() });
                });

                exercisesLibrary.sort((a,b) => a.nome.localeCompare(b.nome));
                renderExerciseList(exercisesLibrary);
            } catch (error) {
                console.error("Errore nel caricare gli esercizi:", error);
                exerciseListContainer.innerHTML = '<p class="text-red-400">Errore nel caricamento degli esercizi.</p>';
            }
        }
        
        function renderExerciseList(exercises) {
            exerciseListContainer.innerHTML = '';
            exercises.forEach(ex => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-slate-800 rounded-lg group';
                div.dataset.exerciseId = ex.id;
                
                const infoPart = document.createElement('div');
                infoPart.className = 'flex items-center gap-4 cursor-pointer flex-grow';
                infoPart.draggable = true;
                infoPart.innerHTML = `
                    <img src="${ex.imageUrl}" alt="${ex.nome}" class="w-12 h-12 rounded-md object-cover" onerror="this.onerror=null;this.src='https://placehold.co/100x100/ef4444/ffffff?text=Error';">
                    <span class="font-semibold text-white">${ex.nome}</span>
                `;
                infoPart.addEventListener('click', () => addExerciseToPlan(ex.id));
                infoPart.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', ex.id);
                });

                const editBtn = document.createElement('button');
                editBtn.className = 'edit-exercise-btn p-2 rounded-md text-slate-400 hover:bg-slate-700 hover:text-white transition-colors opacity-0 group-hover:opacity-100';
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`;
                editBtn.addEventListener('click', () => openExerciseModal(ex));

                div.appendChild(infoPart);
                div.appendChild(editBtn);
                exerciseListContainer.appendChild(div);
            });
        }

        function addExerciseToPlan(exerciseId, details = {}) {
            const exercise = exercisesLibrary.find(ex => ex.id === exerciseId);
            if (!exercise) return;

            planPlaceholder.classList.add('hidden');

            const div = document.createElement('div');
            div.className = 'plan-item bg-slate-700/50 p-3 rounded-lg flex flex-col md:flex-row items-center gap-4';
            div.dataset.exerciseId = exercise.id;
            div.innerHTML = `
                <div class="flex-grow font-bold text-lg text-sky-300 w-full md:w-auto">${exercise.nome}</div>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <input type="text" placeholder="Serie" class="plan-input series-input w-20 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-center" value="${details.serie || ''}">
                    <span class="text-slate-400">x</span>
                    <input type="text" placeholder="Reps" class="plan-input reps-input w-20 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-center" value="${details.ripetizioni || ''}">
                    <input type="text" placeholder="%" class="plan-input perc-input w-20 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-center" value="${details.percentuale || ''}">
                </div>
                <button class="remove-plan-item text-red-500 hover:text-red-400">&times;</button>
            `;
            planExercisesContainer.appendChild(div);
        }

        async function savePlan() {
           const planId = editingPlanIdInput.value;
            const planName = document.getElementById('scheda-name').value;
            if (!planName) {
                showNotification("Inserisci un nome per la scheda.", 'error');
                return;
            }

            const planItems = planExercisesContainer.querySelectorAll('.plan-item');
            if (planItems.length === 0) {
                showNotification("Aggiungi almeno un esercizio alla scheda.", 'error');
                return;
            }

            const exercisesInPlan = [];
            planItems.forEach(item => {
                const exercise = exercisesLibrary.find(ex => ex.id === item.dataset.exerciseId);
                exercisesInPlan.push({
                    esercizioId: item.dataset.exerciseId,
                    nome: exercise.nome,
                    serie: item.querySelector('.series-input').value || '',
                    ripetizioni: item.querySelector('.reps-input').value || '',
                    percentuale: item.querySelector('.perc-input').value || ''
                });
            });

            const planData = {
                nomeScheda: planName,
                esercizi: exercisesInPlan,
                timestamp: serverTimestamp()
            };

            try {
                if (planId) { // Aggiorna scheda esistente
                    const planRef = doc(db, "schede_pesistica", planId);
                    await updateDoc(planRef, planData);
                    showNotification("Scheda aggiornata con successo!");
                } else { // Salva nuova scheda
                    await addDoc(collection(db, "schede_pesistica"), planData);
                    showNotification("Scheda salvata con successo!");
                }
                clearPlan();
                loadAndRenderSavedPlans();
            } catch (error) {
                console.error("Errore salvataggio scheda: ", error);
                showNotification("Errore durante il salvataggio.", 'error');
            }
        }
        
        function clearPlan() {
            document.getElementById('scheda-name').value = '';
            editingPlanIdInput.value = '';
            planExercisesContainer.innerHTML = '';
            planExercisesContainer.appendChild(planPlaceholder);
            planPlaceholder.classList.remove('hidden');
            savePlanBtn.textContent = 'Salva Scheda';
            savePlanBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
            savePlanBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
        }
        
        function openExerciseModal(exercise = null) {
            exerciseImageInput.value = '';
            imageCropperContainer.classList.add('hidden');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }

            if (exercise) {
                modalTitle.textContent = "Modifica Esercizio";
                exerciseIdInput.value = exercise.id;
                exerciseNameInput.value = exercise.nome;
                originalImageURL = exercise.imageUrl;
            } else {
                modalTitle.textContent = "Nuovo Esercizio";
                exerciseIdInput.value = '';
                exerciseNameInput.value = '';
                originalImageURL = null;
            }
            exerciseModal.classList.remove('hidden');
        }

        function closeExerciseModal() {
            exerciseModal.classList.add('hidden');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }
        
        async function handleSaveExercise() {
            const name = exerciseNameInput.value;
            const id = exerciseIdInput.value;
            
            if(!name) {
                showNotification("Il nome è obbligatorio.", 'error');
                return;
            }
            
            const saveButton = document.getElementById('save-exercise-btn');
            saveButton.disabled = true;
            saveButton.textContent = 'Salvataggio...';

            let imageUrl = originalImageURL || "https://placehold.co/100x100/334155/e2e8f0?text=IMG";

            try {
                if (cropper) {
                    const canvas = cropper.getCroppedCanvas({
                        width: 512,
                        height: 512,
                        imageSmoothingQuality: 'high',
                    });

                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                    
                    const storageRef = ref(storage, `exercise_images/${Date.now()}-${name.replace(/\s+/g, '_')}.jpg`);
                    
                    await uploadBytes(storageRef, blob);
                    
                    imageUrl = await getDownloadURL(storageRef);
                }

                const exerciseData = {
                    nome: name.toUpperCase(),
                    imageUrl: imageUrl
                };

                if (id) {
                    const exerciseRef = doc(db, "esercizi_pesistica", id);
                    await updateDoc(exerciseRef, exerciseData);
                    showNotification("Esercizio aggiornato!");
                } else {
                    await addDoc(collection(db, "esercizi_pesistica"), exerciseData);
                    showNotification("Esercizio aggiunto!");
                }

                closeExerciseModal();
                loadAndRenderExercises();

            } catch (error) {
                console.error("Errore salvataggio esercizio: ", error);
                showNotification("Errore durante il salvataggio.", 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Salva';
            }
        }

        async function loadAndRenderSavedPlans() {
            savedPlansListContainer.innerHTML = `<p class="text-slate-400">Caricamento schede...</p>`;
            try {
                const querySnapshot = await getDocs(collection(db, "schede_pesistica"));
                savedPlans = [];
                querySnapshot.forEach(doc => {
                    savedPlans.push({ id: doc.id, ...doc.data() });
                });
                
                savedPlans.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                renderSavedPlans(savedPlans);
            } catch (error) {
                console.error("Errore nel caricare le schede salvate:", error);
                savedPlansListContainer.innerHTML = `<p class="text-red-400">Errore nel caricamento delle schede.</p>`;
            }
        }

        function renderSavedPlans(plans) {
            savedPlansListContainer.innerHTML = '';
            if (plans.length === 0) {
                savedPlansListContainer.innerHTML = `<p class="text-slate-400 text-center">Nessuna scheda salvata.</p>`;
                return;
            }
            plans.forEach(plan => {
                const planDiv = document.createElement('div');
                planDiv.className = 'bg-slate-800 p-4 rounded-lg flex justify-between items-center';
                planDiv.innerHTML = `
                    <div>
                        <p class="font-bold text-white">${plan.nomeScheda}</p>
                        <p class="text-sm text-slate-400">${plan.esercizi.length} esercizi</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button class="edit-plan-btn p-2 rounded-md text-slate-400 hover:bg-slate-700 hover:text-white transition-colors" data-plan-id="${plan.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                        </button>
                        <button class="delete-plan-btn p-2 rounded-md text-red-500 hover:bg-slate-700 hover:text-red-400 transition-colors" data-plan-id="${plan.id}">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </div>
                `;
                savedPlansListContainer.appendChild(planDiv);
            });
        }
        
        function populatePlanForEditing(planId) {
            const plan = savedPlans.find(p => p.id === planId);
            if (!plan) return;

            clearPlan();
            editingPlanIdInput.value = plan.id;
            document.getElementById('scheda-name').value = plan.nomeScheda;

            plan.esercizi.forEach(ex => {
                addExerciseToPlan(ex.esercizioId, ex);
            });

            savePlanBtn.textContent = 'Aggiorna Scheda';
            savePlanBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-500');
            savePlanBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        let planIdToDelete = null;
        function confirmDelete(planId) {
            planIdToDelete = planId;
            deleteConfirmModal.classList.remove('hidden');
        }

        async function executeDelete() {
            if (!planIdToDelete) return;
            try {
                await deleteDoc(doc(db, "schede_pesistica", planIdToDelete));
                showNotification("Scheda eliminata con successo.", 'info');
                planIdToDelete = null;
                deleteConfirmModal.classList.add('hidden');
                loadAndRenderSavedPlans();
            } catch (error) {
                console.error("Errore eliminazione scheda:", error);
                showNotification("Errore durante l'eliminazione.", 'error');
            }
        }
        
        async function initializePage() {
            await loadAndRenderExercises();
            await loadAndRenderSavedPlans();
        }

        initializePage();

        // Event Listeners
        document.getElementById('add-exercise-btn').addEventListener('click', () => openExerciseModal());
        document.getElementById('cancel-exercise-btn').addEventListener('click', closeExerciseModal);
        document.getElementById('save-exercise-btn').addEventListener('click', handleSaveExercise);
        
        document.getElementById('save-plan-btn').addEventListener('click', savePlan);
        document.getElementById('clear-plan-btn').addEventListener('click', clearPlan);

        document.getElementById('exerciseSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = exercisesLibrary.filter(ex => ex.nome.toLowerCase().includes(searchTerm));
            renderExerciseList(filtered);
        });

        exerciseImageInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const reader = new FileReader();
                reader.onload = () => {
                    imageToCrop.src = reader.result;
                    imageCropperContainer.classList.remove('hidden');
                    
                    if (cropper) {
                        cropper.destroy();
                    }

                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 1 / 1,
                        viewMode: 1,
                        background: false,
                        autoCropArea: 0.8,
                    });
                };
                reader.readAsDataURL(files[0]);
            }
        });

        planExercisesContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-plan-item')) {
                e.target.closest('.plan-item').remove();
                if (planExercisesContainer.querySelectorAll('.plan-item').length === 0) { 
                    planPlaceholder.classList.remove('hidden');
                }
            }
        });
        
        savedPlansListContainer.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-plan-btn');
            if (editBtn) {
                populatePlanForEditing(editBtn.dataset.planId);
            }
            
            const deleteBtn = e.target.closest('.delete-plan-btn');
            if (deleteBtn) {
                confirmDelete(deleteBtn.dataset.planId);
            }
        });
        
        document.getElementById('cancel-delete-btn').addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
        document.getElementById('confirm-delete-btn').addEventListener('click', executeDelete);

        planExercisesContainer.addEventListener('dragover', (e) => e.preventDefault());
        planExercisesContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            const exerciseId = e.dataTransfer.getData('text/plain');
            addExerciseToPlan(exerciseId);
        });
    </script>
</body>
</html>

