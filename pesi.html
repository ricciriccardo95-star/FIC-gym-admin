<!DOCTYPE html>
<html lang="it" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Schede e Circuiti</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Libreria per il ritaglio immagini (Cropper.js) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <!-- NOVITÀ: Libreria per il Drag & Drop (Sortable.js) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* Slate 900 */
            color: #E2E8F0; /* Slate 200 */
        }
        .background-gradient {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            filter: blur(100px); z-index: -1;
        }
        .gradient-1 {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.3), transparent 70%);
            animation: pulse 10s infinite alternate;
        }
        .gradient-2 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.2), transparent 70%);
            animation: pulse 12s infinite alternate-reverse;
        }
        @keyframes pulse {
            0% { transform: scale(0.9) rotate(0deg); }
            100% { transform: scale(1.2) rotate(20deg); }
        }
        /* Stile per scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        /* Stili per il cropper */
        .cropper-container { max-height: 400px; }
        .cropper-view-box, .cropper-face { border-radius: 0.5rem; }

        /* Stili per i Tab (Schede/Circuiti) */
        .tab-btn {
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            font-weight: 600;
            color: #94a3b8; /* slate-400 */
            transition: all 0.2s;
        }
        .tab-btn:hover {
            color: #e2e8f0; /* slate-200 */
        }
        .tab-btn.active {
            color: #3b82f6; /* blue-500 */
            border-bottom-color: #3b82f6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* NOVITÀ: Stili per il Drag & Drop (Sortable.js) */
        .drag-handle {
            cursor: move;
            color: #94a3b8; /* slate-400 */
            padding: 0.5rem;
        }
        .drag-handle:hover {
            color: #e2e8f0; /* slate-200 */
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #334155; /* slate-700 */
        }
    </style>
</head>
<body class="antialiased">

    <div class="background-gradient gradient-1"></div>
    <div class="background-gradient gradient-2"></div>

    <div class="p-4 md:p-8 max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl md:text-4xl font-black tracking-tight text-slate-100">Gestione Allenamenti</h1>
            <a href="home_pesi.html" class="inline-flex items-center px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold rounded-lg shadow transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                Indietro
            </a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Colonna Sinistra: Libreria Esercizi -->
            <div class="lg:col-span-1 bg-slate-900/70 border border-slate-700/50 rounded-xl backdrop-blur-lg p-6 flex flex-col">
                <h2 class="text-2xl font-bold text-white mb-4">Libreria Esercizi</h2>
                <div class="mb-4">
                    <input type="text" id="exerciseSearch" placeholder="Cerca esercizio..." class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="exercise-list" class="flex-grow space-y-2 overflow-y-auto max-h-[60vh] pr-2">
                    <!-- Esercizi caricati da JS -->
                </div>
                <button id="add-exercise-btn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    + Aggiungi Nuovo Esercizio
                </button>
            </div>

            <!-- Colonna Destra: Creazione Scheda / Circuito -->
            <div class="lg:col-span-2 bg-slate-900/70 border border-slate-700/50 rounded-xl backdrop-blur-lg p-6">
                
                <!-- Selettore modalità -->
                <div class="mb-4 flex border-b border-slate-700">
                    <button id="view-scheda-btn" class="tab-btn active">Crea Scheda</button>
                    <button id="view-circuito-btn" class="tab-btn">Crea Circuito</button>
                </div>

                <!-- Pannello CREA SCHEDA (default) -->
                <div id="scheda-creator-panel" class="tab-content active">
                    <input type="hidden" id="editing-plan-id">
                    <h2 class="text-2xl font-bold text-white mb-4">Crea Nuova Scheda</h2>
                    <div class="mb-6">
                        <label for="scheda-name" class="block mb-2 font-medium text-slate-300">Nome Scheda</label>
                        <input type="text" id="scheda-name" placeholder="Es. Scheda A - Forza Massimale" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <h3 class="text-lg font-semibold text-slate-200 mb-3">Esercizi nella scheda</h3>
                    <!-- Questo contenitore ora è gestito da Sortable.js -->
                    <div id="plan-exercises" class="space-y-4 min-h-[200px] bg-slate-800/50 p-4 rounded-lg">
                        <p id="plan-placeholder" class="text-slate-400 text-center">Trascina o clicca un esercizio dalla libreria per aggiungerlo qui.</p>
                    </div>
                    <div class="flex justify-end gap-4 mt-6">
                        <button id="clear-plan-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Pulisci</button>
                        <button id="save-plan-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Salva Scheda</button>
                    </div>
                </div>

                <!-- Pannello CREA CIRCUITO (nascosto) -->
                <div id="circuito-creator-panel" class="tab-content">
                    <input type="hidden" id="editing-circuit-id">
                    <h2 class="text-2xl font-bold text-white mb-4">Crea Nuovo Circuito</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="md:col-span-3">
                            <label for="circuito-name" class="block mb-2 font-medium text-slate-300">Nome Circuito</label>
                            <input type="text" id="circuito-name" placeholder="Es. Full Body Burn" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="circuito-lavoro" class="block mb-2 font-medium text-slate-300">Tempo Lavoro</label>
                            <input type="text" id="circuito-lavoro" placeholder="Es. 45s" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="circuito-recupero" class="block mb-2 font-medium text-slate-300">Recupero</label>
                            <input type="text" id="circuito-recupero" placeholder="Es. 15s" class="w-full bg-slate-800 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-slate-200 mb-3">Esercizi nel circuito</h3>
                    <!-- Questo contenitore ora è gestito da Sortable.js -->
                    <div id="circuit-exercises" class="space-y-4 min-h-[200px] bg-slate-800/50 p-4 rounded-lg">
                        <p id="circuit-placeholder" class="text-slate-400 text-center">Trascina o clicca un esercizio dalla libreria per aggiungerlo qui.</p>
                    </div>
                    <div class="flex justify-end gap-4 mt-6">
                        <button id="clear-circuit-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Pulisci</d>
                        <button id="save-circuit-btn" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">Salva Circuito</d>
                    </div>
                </div>

            </div>
        </div>

        <!-- Sezione Riepilogo Elementi Salvati -->
        <div class="mt-12 bg-slate-900/70 border border-slate-700/50 rounded-xl backdrop-blur-lg p-6">
            <h2 class="text-2xl font-bold text-white mb-4">Elementi Salvati</h2>
            
            <!-- Tab per Schede/Circuiti -->
            <div class="mb-4 flex border-b border-slate-700">
                <button id="tab-btn-schede" class="tab-btn active" data-tab="schede">Schede</button>
                <button id="tab-btn-circuiti" class="tab-btn" data-tab="circuiti">Circuiti</button>
            </div>

            <!-- Contenuto Tab Schede -->
            <div id="tab-content-schede" class="tab-content active">
                <div id="saved-plans-list" class="space-y-3">
                    <p class="text-slate-400 text-center">Nessuna scheda salvata.</p>
                </div>
            </div>

            <!-- Contenuto Tab Circuiti -->
            <div id="tab-content-circuiti" class="tab-content">
                <div id="saved-circuits-list" class="space-y-3">
                    <p class="text-slate-400 text-center">Nessun circuito salvato.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per Aggiungere/Modificare Esercizio -->
    <div id="exercise-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4 overflow-y-auto">
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-8 w-full max-w-md">
            <h3 id="modal-title" class="text-2xl font-bold text-white mb-6">Nuovo Esercizio</h3>
            <input type="hidden" id="exercise-id-input">
            <div class="space-y-4">
                <div>
                    <label for="exercise-name-input" class="block mb-2 font-medium text-slate-300">Nome Esercizio</label>
                    <input type="text" id="exercise-name-input" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="exercise-notes-input" class="block mb-2 font-medium text-slate-300">Note Esercizio (opzionale)</label>
                    <textarea id="exercise-notes-input" rows="3" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Es. Dettagli sull'esecuzione, focus muscolare..."></textarea>
                </div>
                <div>
                    <label for="exercise-image-input" class="block mb-2 font-medium text-slate-300">Immagine Esercizio</label>
                    <input type="file" id="exercise-image-input" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-500 cursor-pointer" accept="image/*">
                </div>
                <div id="image-cropper-container" class="hidden mt-4">
                    <img id="image-to-crop" class="max-w-full">
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button id="cancel-exercise-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg">Annulla</button>
                <button id="save-exercise-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-6 rounded-lg">Salva</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Conferma Eliminazione -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="bg-slate-800 border border-slate-700 rounded-lg p-8 w-full max-w-sm text-center">
            <h3 class="text-xl font-bold text-white mb-4">Sei sicuro?</h3>
            <p id="delete-confirm-message" class="text-slate-300 mb-6">Vuoi davvero eliminare questo elemento? L'azione è irreversibile.</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg">Annulla</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg">Elimina</button>
            </div>
        </div>
    </div>

    <!-- Notifica -->
    <div id="notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2 transition-all z-50"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAQ_0F8KCks_4Wn2h2aTIepQY9VrIkWpUQ",
            authDomain: "database-atleti-fic.firebaseapp.com",
            projectId: "database-atleti-fic",
            storageBucket: "database-atleti-fic.appspot.com",
            messagingSenderId: "860422140545",
            appId: "1:860422140545:web:cd14c042a47f2650681380"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let exercisesLibrary = [];
        let savedPlans = [];
        let savedCircuits = []; // NUOVO: Array per circuiti
        let cropper = null;
        let originalImageURL = null;
        let currentView = 'scheda'; // 'scheda' o 'circuito'
        let itemToDelete = { id: null, type: null }; // Per eliminazione

        // --- Elementi DOM principali ---
        const exerciseListContainer = document.getElementById('exercise-list');
        const notificationEl = document.getElementById('notification');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteConfirmMessage = document.getElementById('delete-confirm-message');

        // --- Elementi DOM Scheda ---
        const schedaCreatorPanel = document.getElementById('scheda-creator-panel');
        const planExercisesContainer = document.getElementById('plan-exercises');
        const planPlaceholder = document.getElementById('plan-placeholder');
        const editingPlanIdInput = document.getElementById('editing-plan-id');
        const savePlanBtn = document.getElementById('save-plan-btn');
        const savedPlansListContainer = document.getElementById('saved-plans-list');
        const schedaNameInput = document.getElementById('scheda-name');

        // --- Elementi DOM Circuito ---
        const circuitoCreatorPanel = document.getElementById('circuito-creator-panel');
        const circuitExercisesContainer = document.getElementById('circuit-exercises');
        const circuitPlaceholder = document.getElementById('circuit-placeholder');
        const editingCircuitIdInput = document.getElementById('editing-circuit-id');
        const saveCircuitBtn = document.getElementById('save-circuit-btn');
        const savedCircuitsListContainer = document.getElementById('saved-circuits-list');
        const circuitoNameInput = document.getElementById('circuito-name');
        const circuitoLavoroInput = document.getElementById('circuito-lavoro');
        const circuitoRecuperoInput = document.getElementById('circuito-recupero');

        // --- Elementi DOM Modal Esercizi ---
        const exerciseModal = document.getElementById('exercise-modal');
        const modalTitle = document.getElementById('modal-title');
        const exerciseIdInput = document.getElementById('exercise-id-input');
        const exerciseNameInput = document.getElementById('exercise-name-input');
        const exerciseImageInput = document.getElementById('exercise-image-input');
        const exerciseNotesInput = document.getElementById('exercise-notes-input');
        const imageCropperContainer = document.getElementById('image-cropper-container');
        const imageToCrop = document.getElementById('image-to-crop');

        
        // --- NOVITÀ: Inizializzazione SortableJS per riordino ---
        // (Assicurarsi che Sortable sia caricato prima di questo script, vedi <head>)
        new Sortable(planExercisesContainer, {
            animation: 150,
            handle: '.drag-handle', // Classe dell'icona per trascinare
            ghostClass: 'sortable-ghost', // Classe per l'elemento fantasma
            filter: '.plan-input, .tipo-serie-select, .remove-item-btn, .add-set-row-btn', // Non iniziare il drag se si clicca su input/bottoni
            preventOnFilter: false // MODIFICATO: Permette il click sugli input
        });

        new Sortable(circuitExercisesContainer, {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            filter: '.circuit-peso-input, .circuit-note-input, .remove-item-btn', // Non iniziare il drag se si clicca su input/bottoni
            preventOnFilter: false // MODIFICATO: Permette il click sugli input
        });


        function showNotification(message, type = 'success') {
            notificationEl.textContent = message;
            notificationEl.className = 'fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-all z-50'; // Reset
            if (type === 'success') notificationEl.classList.add('bg-green-500');
            else if (type === 'error') notificationEl.classList.add('bg-red-500');
            else notificationEl.classList.add('bg-blue-500');
            notificationEl.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                notificationEl.classList.add('opacity-0', 'translate-y-2');
            }, 3000);
        }

        async function populateInitialExercises() {
             const initialExercises = [
                { nome: "BACK SQUAT", imageUrl: "https://placehold.co/100x100/334155/e2e8f0?text=SQUAT", note: "" },
                { nome: "PANCA PIANA", imageUrl: "https://placehold.co/100x100/334155/e2e8f0?text=PANCA", note: "" },
                { nome: "STACCHI", imageUrl: "https://placehold.co/100x100/334155/e2e8f0?text=STACCO", note: "" },
            ];
            const promises = initialExercises.map(ex => addDoc(collection(db, "esercizi_pesistica"), ex));
            await Promise.all(promises);
            console.log("Esercizi iniziali popolati in Firestore.");
        }

        async function loadAndRenderExercises() {
            exerciseListContainer.innerHTML = '<p class="text-slate-400">Caricamento...</p>';
            try {
                const querySnapshot = await getDocs(collection(db, "esercizi_pesistica"));
                
                if (querySnapshot.empty) {
                    await populateInitialExercises();
                    await loadAndRenderExercises();
                    return;
                }

                exercisesLibrary = [];
                querySnapshot.forEach((doc) => {
                    exercisesLibrary.push({ id: doc.id, ...doc.data() });
                });

                exercisesLibrary.sort((a,b) => a.nome.localeCompare(b.nome));
                renderExerciseList(exercisesLibrary);
            } catch (error) {
                console.error("Errore nel caricare gli esercizi:", error);
                exerciseListContainer.innerHTML = '<p class="text-red-400">Errore nel caricamento degli esercizi.</p>';
            }
        }
        
        function renderExerciseList(exercises) {
            exerciseListContainer.innerHTML = '';
            exercises.forEach(ex => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-slate-800 rounded-lg group';
                div.dataset.exerciseId = ex.id;
                
                const infoPart = document.createElement('div');
                infoPart.className = 'flex items-center gap-4 cursor-pointer flex-grow';
                infoPart.draggable = true;
                infoPart.innerHTML = `
                    <img src="${ex.imageUrl}" alt="${ex.nome}" class="w-12 h-12 rounded-md object-cover" onerror="this.onerror=null;this.src='https://placehold.co/100x100/ef4444/ffffff?text=Error';">
                    <span class="font-semibold text-white">${ex.nome}</span>
                `;
                // MODIFICATO: Chiama la funzione corretta in base alla vista
                infoPart.addEventListener('click', () => addExerciseToCurrentPlan(ex.id));
                infoPart.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', ex.id);
                });

                const editBtn = document.createElement('button');
                editBtn.className = 'edit-exercise-btn p-2 rounded-md text-slate-400 hover:bg-slate-700 hover:text-white transition-colors opacity-0 group-hover:opacity-100';
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`;
                editBtn.addEventListener('click', () => openExerciseModal(ex));

                div.appendChild(infoPart);
                div.appendChild(editBtn);
                exerciseListContainer.appendChild(div);
            });
        }

        // --- NUOVA FUNZIONE: Decide dove aggiungere l'esercizio ---
        function addExerciseToCurrentPlan(exerciseId, details = {}) {
            if (currentView === 'scheda') {
                addExerciseToScheda(exerciseId, details);
            } else {
                addExerciseToCircuito(exerciseId, details);
            }
        }

        // --- FUNZIONE HELPER per riga set (Scheda) ---
        function createSetRow(setData = {}) {
            const row = document.createElement('div');
            row.className = 'plan-item-set-row flex flex-col sm:flex-row items-center gap-3';
            row.innerHTML = `
                <div class="flex items-center gap-3">
                    <input type="text" placeholder="Serie" class="plan-input series-input w-20 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-center" value="${setData.serie || ''}">
                    <span class="text-slate-400">x</span>
                    <input type="text" placeholder="Reps" class="plan-input reps-input w-20 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-center" value="${setData.ripetizioni || ''}">
                    <input type="text" placeholder="%" class="plan-input perc-input w-20 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-center" value="${setData.percentuale || ''}">
                </div>
                <input type="text" placeholder="Note sulla serie..." class="plan-input notes-input flex-grow bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm" value="${setData.note || ''}">
                <button type="button" class="remove-set-row-btn text-red-500 hover:text-red-400 p-1 rounded-md hover:bg-slate-800" title="Rimuovi serie">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            `;
            // NOTA: Ho cambiato la classe del bottone rimuovi serie in "remove-set-row-btn"
            return row;
        }

        // --- Funzione per aggiungere esercizio a SCHEDA (ex addExerciseToPlan) ---
        function addExerciseToScheda(exerciseId, details = {}) {
            const exercise = exercisesLibrary.find(ex => ex.id === exerciseId);
            if (!exercise) return;

            planPlaceholder.classList.add('hidden');

            const div = document.createElement('div');
            div.className = 'plan-item bg-slate-700/50 p-3 rounded-lg flex flex-col gap-3';
            div.dataset.exerciseId = exercise.id;

            const tipoSerie = details.tipo || 'fisse';
            const setsData = details.sets && details.sets.length > 0 ? details.sets : [{}];

            const header = document.createElement('div');
            header.className = 'flex justify-between items-center gap-4 flex-wrap';
            
            // --- MODIFICATO: Aggiunto drag-handle ---
            header.innerHTML = `
                <div class="flex items-center gap-2 flex-grow">
                    <span class="drag-handle" title="Trascina per riordinare">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </span>
                    <div class="font-bold text-lg text-sky-300">${exercise.nome}</div>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-sm text-slate-300">Tipo:</label>
                    <select class="tipo-serie-select bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="fisse" ${tipoSerie === 'fisse' ? 'selected' : ''}>Fisse</option>
                        <option value="piramidale" ${tipoSerie === 'piramidale' ? 'selected' : ''}>Piramidale</option>
                    </select>
                </div>
                <button class="remove-item-btn text-red-500 hover:text-red-400 p-1 -mr-1 -mt-1" title="Rimuovi esercizio">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            `;
            // --- FINE MODIFICA ---

            const setsContainer = document.createElement('div');
            setsContainer.className = 'sets-container space-y-3';
            
            const addSetBtn = document.createElement('button');
            addSetBtn.type = 'button';
            addSetBtn.className = 'add-set-row-btn self-start text-sm bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-1 px-3 rounded-lg transition-colors';
            addSetBtn.innerHTML = '+ Aggiungi Serie';
            if (tipoSerie !== 'piramidale') addSetBtn.classList.add('hidden');

            setsData.forEach(set => {
                setsContainer.appendChild(createSetRow(set));
            });

            div.appendChild(header);
            div.appendChild(setsContainer);
            div.appendChild(addSetBtn);
            planExercisesContainer.appendChild(div);

            const tipoSelect = header.querySelector('.tipo-serie-select');
            tipoSelect.addEventListener('change', () => {
                if (tipoSelect.value === 'piramidale') {
                    addSetBtn.classList.remove('hidden');
                } else {
                    addSetBtn.classList.add('hidden');
                    while (setsContainer.children.length > 1) {
                        setsContainer.removeChild(setsContainer.lastChild);
                    }
                }
            });

            addSetBtn.addEventListener('click', () => {
                setsContainer.appendChild(createSetRow());
            });
        }

        // --- NUOVA FUNZIONE: Aggiungere esercizio a CIRCUITO ---
        function addExerciseToCircuito(exerciseId, details = {}) {
            const exercise = exercisesLibrary.find(ex => ex.id === exerciseId);
            if (!exercise) return;

            circuitPlaceholder.classList.add('hidden');

            const div = document.createElement('div');
            // --- MODIFICATO: Aggiunto sm:items-center per allineare l'handle ---
            div.className = 'circuit-item bg-slate-700/50 p-3 rounded-lg flex flex-col sm:flex-row sm:items-center gap-3';
            div.dataset.exerciseId = exercise.id;
            
            // --- MODIFICATO: Aggiunto drag-handle ---
            div.innerHTML = `
                <span class="drag-handle" title="Trascina per riordinare">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </span>
                <div class="flex-grow font-bold text-lg text-purple-300">${exercise.nome}</div>
                <input type="text" placeholder="Peso" class="circuit-peso-input w-full sm:w-24 bg-slate-800 border border-slate-600 rounded px-2 py-1 text-center" value="${details.peso || ''}">
                <input type="text" placeholder="Note..." class="circuit-note-input w-full sm:flex-grow bg-slate-800 border border-slate-600 rounded px-2 py-1 text-sm" value="${details.note || ''}">
                <button class="remove-item-btn text-red-500 hover:text-red-400 p-1 self-end sm:self-center" title="Rimuovi esercizio">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            `;
            // --- FINE MODIFICA ---
            
            circuitExercisesContainer.appendChild(div);
        }

        // --- Funzione SALVA SCHEDA ---
        async function savePlan() {
           const planId = editingPlanIdInput.value;
            const planName = schedaNameInput.value;
            if (!planName) {
                showNotification("Inserisci un nome per la scheda.", 'error');
                return;
            }

            // L'ordine è determinato da querySelectorAll, che rispetta l'ordine del DOM (modificato da Sortable.js)
            const planItems = planExercisesContainer.querySelectorAll('.plan-item');
            if (planItems.length === 0) {
                showNotification("Aggiungi almeno un esercizio alla scheda.", 'error');
                return;
            }

            const exercisesInPlan = [];
            planItems.forEach((item, index) => { // Aggiunto index per l'ordine
                const exercise = exercisesLibrary.find(ex => ex.id === item.dataset.exerciseId);
                const tipoSerie = item.querySelector('.tipo-serie-select').value;
                const setRows = item.querySelectorAll('.plan-item-set-row');
                
                const setsArray = [];
                setRows.forEach(row => {
                    setsArray.push({
                        serie: row.querySelector('.series-input').value || '',
                        ripetizioni: row.querySelector('.reps-input').value || '',
                        percentuale: row.querySelector('.perc-input').value || '',
                        note: row.querySelector('.notes-input').value || ''
                    });
                });

                exercisesInPlan.push({
                    esercizioId: item.dataset.exerciseId,
                    nome: exercise.nome,
                    tipo: tipoSerie,
                    sets: setsArray,
                    ordine: index // Salva l'ordine
                });
            });

            const planData = {
                nomeScheda: planName,
                esercizi: exercisesInPlan,
                timestamp: serverTimestamp()
            };

            try {
                if (planId) {
                    const planRef = doc(db, "schede_pesistica", planId);
                    await updateDoc(planRef, planData);
                    showNotification("Scheda aggiornata con successo!");
                } else {
                    await addDoc(collection(db, "schede_pesistica"), planData);
                    showNotification("Scheda salvata con successo!");
                }
                clearPlan();
                loadAndRenderSavedItems(); // Aggiornata
            } catch (error) {
                console.error("Errore salvataggio scheda: ", error);
                showNotification("Errore during il salvataggio.", 'error');
            }
        }

        // --- NUOVA FUNZIONE: SALVA CIRCUITO ---
        async function saveCircuit() {
            const circuitId = editingCircuitIdInput.value;
            const circuitName = circuitoNameInput.value;
            const tempoLavoro = circuitoLavoroInput.value;
            const tempoRecupero = circuitoRecuperoInput.value;

            if (!circuitName) {
                showNotification("Inserisci un nome per il circuito.", 'error');
                return;
            }

            // L'ordine è determinato da querySelectorAll
            const circuitItems = circuitExercisesContainer.querySelectorAll('.circuit-item');
            if (circuitItems.length === 0) {
                showNotification("Aggiungi almeno un esercizio al circuito.", 'error');
                return;
            }

            const exercisesInCircuit = [];
            circuitItems.forEach((item, index) => { // Aggiunto index per l'ordine
                const exercise = exercisesLibrary.find(ex => ex.id === item.dataset.exerciseId);
                exercisesInCircuit.push({
                    esercizioId: item.dataset.exerciseId,
                    nome: exercise.nome,
                    peso: item.querySelector('.circuit-peso-input').value || '',
                    note: item.querySelector('.circuit-note-input').value || '',
                    ordine: index // Salva l'ordine
                });
            });

            const circuitData = {
                nomeCircuito: circuitName,
                tempoLavoro: tempoLavoro,
                tempoRecupero: tempoRecupero,
                esercizi: exercisesInCircuit,
                timestamp: serverTimestamp()
            };

            try {
                if (circuitId) {
                    const circuitRef = doc(db, "circuiti_pesistica", circuitId);
                    await updateDoc(circuitRef, circuitData);
                    showNotification("Circuito aggiornato con successo!");
                } else {
                    await addDoc(collection(db, "circuiti_pesistica"), circuitData);
                    showNotification("Circuito salvato con successo!");
                }
                clearCircuit();
                loadAndRenderSavedItems(); // Aggiornata
            } catch (error) {
                console.error("Errore salvataggio circuito: ", error);
                showNotification("Errore during il salvataggio.", 'error');
            }
        }
        
        // --- Funzione Pulisci Scheda ---
        function clearPlan() {
            schedaNameInput.value = '';
            editingPlanIdInput.value = '';
            planExercisesContainer.innerHTML = '';
            planExercisesContainer.appendChild(planPlaceholder);
            planPlaceholder.classList.remove('hidden');
            savePlanBtn.textContent = 'Salva Scheda';
            savePlanBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
            savePlanBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
        }

        // --- NUOVA FUNZIONE: Pulisci Circuito ---
        function clearCircuit() {
            circuitoNameInput.value = '';
            circuitoLavoroInput.value = '';
            circuitoRecuperoInput.value = '';
            editingCircuitIdInput.value = '';
            circuitExercisesContainer.innerHTML = '';
            circuitExercisesContainer.appendChild(circuitPlaceholder);
            circuitPlaceholder.classList.remove('hidden');
            saveCircuitBtn.textContent = 'Salva Circuito';
            saveCircuitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-500');
            saveCircuitBtn.classList.add('bg-purple-600', 'hover:bg-purple-500');
        }
        
        // --- Funzione Apri Modal Esercizio ---
        function openExerciseModal(exercise = null) {
            exerciseImageInput.value = '';
            imageCropperContainer.classList.add('hidden');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }

            if (exercise) {
                modalTitle.textContent = "Modifica Esercizio";
                exerciseIdInput.value = exercise.id;
                exerciseNameInput.value = exercise.nome;
                exerciseNotesInput.value = exercise.note || '';
                originalImageURL = exercise.imageUrl;
            } else {
                modalTitle.textContent = "Nuovo Esercizio";
                exerciseIdInput.value = '';
                exerciseNameInput.value = '';
                exerciseNotesInput.value = '';
                originalImageURL = null;
            }
            exerciseModal.classList.remove('hidden');
        }

        function closeExerciseModal() {
            exerciseModal.classList.add('hidden');
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }
        
        // --- Funzione Salva Esercizio (da modal) ---
        async function handleSaveExercise() {
            const name = exerciseNameInput.value;
            const note = exerciseNotesInput.value;
            const id = exerciseIdInput.value;
            
            if(!name) {
                showNotification("Il nome è obbligatorio.", 'error');
                return;
            }
            
            const saveButton = document.getElementById('save-exercise-btn');
            saveButton.disabled = true;
            saveButton.textContent = 'Salvataggio...';

            let imageUrl = originalImageURL || "https://placehold.co/100x100/334155/e2e8f0?text=IMG";

            try {
                if (cropper) {
                    const canvas = cropper.getCroppedCanvas({
                        width: 512,
                        height: 512,
                        imageSmoothingQuality: 'high',
                    });
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
                    const storageRef = ref(storage, `exercise_images/${Date.now()}-${name.replace(/\s+/g, '_')}.jpg`);
                    await uploadBytes(storageRef, blob);
                    imageUrl = await getDownloadURL(storageRef);
                }

                const exerciseData = {
                    nome: name.toUpperCase(),
                    imageUrl: imageUrl,
                    note: note
                };

                if (id) {
                    const exerciseRef = doc(db, "esercizi_pesistica", id);
                    await updateDoc(exerciseRef, exerciseData);
                    showNotification("Esercizio aggiornato!");
                } else {
                    await addDoc(collection(db, "esercizi_pesistica"), exerciseData);
                    showNotification("Esercizio aggiunto!");
                }

                closeExerciseModal();
                loadAndRenderExercises();

            } catch (error) {
                console.error("Errore salvataggio esercizio: ", error);
                showNotification("Errore during il salvataggio.", 'error');
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Salva';
            }
        }

        // --- MODIFICATA: Carica e Renderizza TUTTI gli elementi salvati ---
        async function loadAndRenderSavedItems() {
            savedPlansListContainer.innerHTML = `<p class="text-slate-400">Caricamento schede...</p>`;
            savedCircuitsListContainer.innerHTML = `<p class="text-slate-400">Caricamento circuiti...</p>`;
            
            try {
                // Carica Schede
                const plansSnapshot = await getDocs(collection(db, "schede_pesistica"));
                savedPlans = [];
                plansSnapshot.forEach(doc => {
                    savedPlans.push({ id: doc.id, ...doc.data() });
                });
                savedPlans.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderSavedPlansList(savedPlans);

                // Carica Circuiti
                const circuitsSnapshot = await getDocs(collection(db, "circuiti_pesistica"));
                savedCircuits = [];
                circuitsSnapshot.forEach(doc => {
                    savedCircuits.push({ id: doc.id, ...doc.data() });
                });
                savedCircuits.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderSavedCircuitsList(savedCircuits);

            } catch (error) {
                console.error("Errore nel caricare gli elementi salvati:", error);
                savedPlansListContainer.innerHTML = `<p class="text-red-400">Errore nel caricamento delle schede.</p>`;
                savedCircuitsListContainer.innerHTML = `<p class="text-red-400">Errore nel caricamento dei circuiti.</p>`;
            }
        }

        // --- Funzione Renderizza Schede Salvate ---
        function renderSavedPlansList(plans) {
            savedPlansListContainer.innerHTML = '';
            if (plans.length === 0) {
                savedPlansListContainer.innerHTML = `<p class="text-slate-400 text-center">Nessuna scheda salvata.</p>`;
                return;
            }
            plans.forEach(plan => {
                const planDiv = document.createElement('div');
                planDiv.className = 'bg-slate-800 p-4 rounded-lg flex justify-between items-center';
                planDiv.innerHTML = `
                    <div>
                        <p class="font-bold text-white">${plan.nomeScheda}</p>
                        <p class="text-sm text-slate-400">${plan.esercizi.length} esercizi</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button class="edit-btn p-2 rounded-md text-slate-400 hover:bg-slate-700 hover:text-white transition-colors" data-id="${plan.id}" data-type="scheda">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                        </button>
                        <button class="delete-btn p-2 rounded-md text-red-500 hover:bg-slate-700 hover:text-red-400 transition-colors" data-id="${plan.id}" data-type="scheda">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </div>
                `;
                savedPlansListContainer.appendChild(planDiv);
            });
        }

        // --- NUOVA FUNZIONE: Renderizza Circuiti Salvati ---
        function renderSavedCircuitsList(circuits) {
            savedCircuitsListContainer.innerHTML = '';
            if (circuits.length === 0) {
                savedCircuitsListContainer.innerHTML = `<p class="text-slate-400 text-center">Nessun circuito salvato.</p>`;
                return;
            }
            circuits.forEach(circuit => {
                const circuitDiv = document.createElement('div');
                circuitDiv.className = 'bg-slate-800 p-4 rounded-lg flex justify-between items-center';
                circuitDiv.innerHTML = `
                    <div>
                        <p class="font-bold text-white">${circuit.nomeCircuito}</p>
                        <p class="text-sm text-slate-400">${circuit.esercizi.length} esercizi / ${circuit.tempoLavoro || 'N/A'} - ${circuit.tempoRecupero || 'N/A'}</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button class="edit-btn p-2 rounded-md text-slate-400 hover:bg-slate-700 hover:text-white transition-colors" data-id="${circuit.id}" data-type="circuito">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                        </button>
                        <button class="delete-btn p-2 rounded-md text-red-500 hover:bg-slate-700 hover:text-red-400 transition-colors" data-id="${circuit.id}" data-type="circuito">
                             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </div>
                `;
                savedCircuitsListContainer.appendChild(circuitDiv);
            });
        }
        
        // --- Funzione Popola Scheda per Modifica ---
        function populatePlanForEditing(planId) {
            const plan = savedPlans.find(p => p.id === planId);
            if (!plan) return;

            clearPlan();
            editingPlanIdInput.value = plan.id;
            schedaNameInput.value = plan.nomeScheda;

            // Ordina gli esercizi in base alla proprietà 'ordine' prima di aggiungerli
            const orderedExercises = (plan.esercizi || []).sort((a, b) => (a.ordine || 0) - (b.ordine || 0));
            
            orderedExercises.forEach(ex => {
                addExerciseToScheda(ex.esercizioId, ex);
            });

            savePlanBtn.textContent = 'Aggiorna Scheda';
            savePlanBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-500');
            savePlanBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');
            
            // Cambia vista e scrolla
            switchView('scheda');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- NUOVA FUNZIONE: Popola Circuito per Modifica ---
        function populateCircuitForEditing(circuitId) {
            const circuit = savedCircuits.find(c => c.id === circuitId);
            if (!circuit) return;

            clearCircuit();
            editingCircuitIdInput.value = circuit.id;
            circuitoNameInput.value = circuit.nomeCircuito;
            circuitoLavoroInput.value = circuit.tempoLavoro;
            circuitoRecuperoInput.value = circuit.tempoRecupero;

            // Ordina gli esercizi in base alla proprietà 'ordine' prima di aggiungerli
            const orderedExercises = (circuit.esercizi || []).sort((a, b) => (a.ordine || 0) - (b.ordine || 0));

            orderedExercises.forEach(ex => {
                addExerciseToCircuito(ex.esercizioId, ex);
            });

            saveCircuitBtn.textContent = 'Aggiorna Circuito';
            saveCircuitBtn.classList.remove('bg-purple-600', 'hover:bg-purple-500');
            saveCircuitBtn.classList.add('bg-blue-600', 'hover:bg-blue-500');

            // Cambia vista e scrolla
            switchView('circuito');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // --- MODIFICATA: Conferma Eliminazione ---
        function confirmDelete(id, type) {
            itemToDelete = { id: id, type: type };
            deleteConfirmMessage.textContent = `Vuoi davvero eliminare questo ${type}? L'azione è irreversibile.`;
            deleteConfirmModal.classList.remove('hidden');
        }

        // --- MODIFICATA: Esegui Eliminazione ---
        async function executeDelete() {
            if (!itemToDelete.id || !itemToDelete.type) return;

            const { id, type } = itemToDelete;
            const collectionName = type === 'scheda' ? 'schede_pesistica' : 'circuiti_pesistica';

            try {
                await deleteDoc(doc(db, collectionName, id));
                showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} eliminato/a.`, 'info');
                itemToDelete = { id: null, type: null };
                deleteConfirmModal.classList.add('hidden');
                loadAndRenderSavedItems(); // Ricarica tutto
            } catch (error) {
                console.error(`Errore eliminazione ${type}:`, error);
                showNotification("Errore during l'eliminazione.", 'error');
            }
        }

        // --- NUOVA FUNZIONE: Cambia Vista (Scheda/Circuito) ---
        function switchView(view) {
            currentView = view;
            if (view === 'scheda') {
                schedaCreatorPanel.classList.add('active');
                circuitoCreatorPanel.classList.remove('active');
                document.getElementById('view-scheda-btn').classList.add('active');
                document.getElementById('view-circuito-btn').classList.remove('active');
            } else {
                schedaCreatorPanel.classList.remove('active');
                circuitoCreatorPanel.classList.add('active');
                document.getElementById('view-scheda-btn').classList.remove('active');
                document.getElementById('view-circuito-btn').classList.add('active');
            }
        }
        
        // --- NUOVA FUNZIONE: Cambia Tab (Liste Salvate) ---
        function switchSavedItemsTab(tab) {
            if (tab === 'schede') {
                document.getElementById('tab-content-schede').classList.add('active');
                document.getElementById('tab-content-circuiti').classList.remove('active');
                document.getElementById('tab-btn-schede').classList.add('active');
                document.getElementById('tab-btn-circuiti').classList.remove('active');
            } else {
                document.getElementById('tab-content-schede').classList.remove('active');
                document.getElementById('tab-content-circuiti').classList.add('active');
                document.getElementById('tab-btn-schede').classList.remove('active');
                document.getElementById('tab-btn-circuiti').classList.add('active');
            }
        }
        
        async function initializePage() {
            await loadAndRenderExercises();
            await loadAndRenderSavedItems();
        }

        initializePage();

        // --- Event Listeners ---

        // Switch Viste Creazione
        document.getElementById('view-scheda-btn').addEventListener('click', () => switchView('scheda'));
        document.getElementById('view-circuito-btn').addEventListener('click', () => switchView('circuito'));
        
        // Switch Tab Liste Salvate
        document.getElementById('tab-btn-schede').addEventListener('click', () => switchSavedItemsTab('schede'));
        document.getElementById('tab-btn-circuiti').addEventListener('click', () => switchSavedItemsTab('circuiti'));

        // Modal Esercizi
        document.getElementById('add-exercise-btn').addEventListener('click', () => openExerciseModal());
        document.getElementById('cancel-exercise-btn').addEventListener('click', closeExerciseModal);
        document.getElementById('save-exercise-btn').addEventListener('click', handleSaveExercise);
        
        // Bottoni Scheda
        document.getElementById('save-plan-btn').addEventListener('click', savePlan);
        document.getElementById('clear-plan-btn').addEventListener('click', clearPlan);

        // Bottoni Circuito
        document.getElementById('save-circuit-btn').addEventListener('click', saveCircuit);
        document.getElementById('clear-circuit-btn').addEventListener('click', clearCircuit);

        // Cerca Esercizio
        document.getElementById('exerciseSearch').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = exercisesLibrary.filter(ex => ex.nome.toLowerCase().includes(searchTerm));
            renderExerciseList(filtered);
        });

        // Cropper Immagine
        exerciseImageInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const reader = new FileReader();
                reader.onload = () => {
                    imageToCrop.src = reader.result;
                    imageCropperContainer.classList.remove('hidden');
                    
                    if (cropper) cropper.destroy();
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 1 / 1, viewMode: 1, background: false, autoCropArea: 0.8,
                    });
                };
                reader.readAsDataURL(files[0]);
            }
        });

        // Event listener unificato per rimuovere item (scheda o circuito)
        function handleRemoveItem(e) {
            // Rimuovi intero esercizio (sia da scheda che da circuito)
            const removeItemBtn = e.target.closest('.remove-item-btn');
            if (removeItemBtn) {
                const item = removeItemBtn.closest('.plan-item, .circuit-item');
                if (!item) return;
                const container = item.parentElement;
                item.remove();
                
                // Controlla se rimettere il placeholder
                if (container.id === 'plan-exercises' && container.querySelectorAll('.plan-item').length === 0) { 
                    planPlaceholder.classList.remove('hidden');
                } else if (container.id === 'circuit-exercises' && container.querySelectorAll('.circuit-item').length === 0) {
                    circuitPlaceholder.classList.remove('hidden');
                }
                return;
            }

            // Rimuovi una riga di set (solo per schede)
            const removeSetBtn = e.target.closest('.remove-set-row-btn'); // Questo ID/classe è solo in schede
            if (removeSetBtn) {
                const setRow = removeSetBtn.closest('.plan-item-set-row');
                if (!setRow) return;
                const setsContainer = setRow.closest('.sets-container');
                if (setsContainer.children.length > 1) {
                    setRow.remove();
                } else {
                    showNotification("Un esercizio deve avere almeno una serie.", 'error');
                }
            }
        }
        
        planExercisesContainer.addEventListener('click', handleRemoveItem);
        circuitExercisesContainer.addEventListener('click', handleRemoveItem);
        
        // Event listener unificato per liste salvate (Modifica/Elimina)
        function handleSavedItemActions(e) {
            const btn = e.target.closest('.edit-btn, .delete-btn');
            if (!btn) return;
            
            const id = btn.dataset.id;
            const type = btn.dataset.type; // 'scheda' o 'circuito'

            if (btn.classList.contains('edit-btn')) {
                if (type === 'scheda') populatePlanForEditing(id);
                else if (type === 'circuito') populateCircuitForEditing(id);
            } else if (btn.classList.contains('delete-btn')) {
                confirmDelete(id, type);
            }
        }
        
        savedPlansListContainer.addEventListener('click', handleSavedItemActions);
        savedCircuitsListContainer.addEventListener('click', handleSavedItemActions);
        
        // Modal Eliminazione
        document.getElementById('cancel-delete-btn').addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
        document.getElementById('confirm-delete-btn').addEventListener('click', executeDelete);

        // Drag & Drop (Dalla libreria alla scheda)
        function handleDragOver(e) { e.preventDefault(); }
        function handleDrop(e) {
            e.preventDefault();
            const exerciseId = e.dataTransfer.getData('text/plain');
            // La funzione capirà da sola dove aggiungere l'esercizio
            addExerciseToCurrentPlan(exerciseId);
        }

        planExercisesContainer.addEventListener('dragover', handleDragOver);
        planExercisesContainer.addEventListener('drop', handleDrop);
        circuitExercisesContainer.addEventListener('dragover', handleDragOver);
        circuitExercisesContainer.addEventListener('drop', handleDrop);
    </script>
</body>
</html>
